<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PayHere Checkout</title>
</head>
<body>
<h2>Checkout</h2>
<button id="pay-now">Pay with PayHere</button>

<script src="https://www.payhere.lk/lib/payhere.js"></script>
<script>
    const buyerToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY3ZTc1NDE2NGQ5NTRlYzJkMDA1NzUyNCIsInJvbGUiOiJidXllciIsImlhdCI6MTc0MzU4NTg4MywiZXhwIjoxNzQzNTg5NDgzfQ.VLwGufLEOC9uVIIlukrGJw3Wq71QzMaD_cC_rz1E6ck"; // Replace with actual token

    async function createOrder(items = []) {
        const response = await fetch("http://localhost:3000/api/buyer/order", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${buyerToken}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ items }),
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.message);
        return data.data;
    }

    payhere.onCompleted = function onCompleted(orderId) {
        console.log("Payment completed. OrderID: " + orderId);
        alert("Payment successful! Order ID: " + orderId);
    };

    payhere.onDismissed = function onDismissed() {
        console.log("Payment dismissed");
        alert("Payment was dismissed.");
    };

    payhere.onError = function onError(error) {
        console.log("Error: " + error);
        alert("Payment error: " + error);
    };

    document.getElementById("pay-now").addEventListener("click", async () => {
        try {
            const { orderId, payhereData } = await createOrder([
                { productId: "67ea96914abbf7f7e41bb42f", quantity: 1 },
            ]);
            payhere.startPayment(payhereData);
        } catch (err) {
            console.error("Order creation error:", err);
            alert("Failed to initiate payment: " + err.message);
        }
    });
</script>
</body>
</html>